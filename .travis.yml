language: go
go:
  - 1.6
  - tip
env:
  - VAULT_ADDR='http://127.0.0.1:8200'
services:
  - redis
before_install:
  # install consul
  - wget https://dl.bintray.com/mitchellh/consul/0.5.0_linux_amd64.zip
  - unzip 0.5.0_linux_amd64.zip
  - sudo mv consul /bin/
  - consul agent -server -bootstrap-expect 1 -data-dir /tmp/consul &
  # install etcd
  - wget https://github.com/coreos/etcd/releases/download/v2.0.9/etcd-v2.0.9-linux-amd64.tar.gz
  - tar xzf etcd-v2.0.9-linux-amd64.tar.gz
  - sudo mv etcd-v2.0.9-linux-amd64/etcd /bin/
  - etcd &
  # install DynamoDB
  - mkdir /tmp/dynamodb
  - wget -O - http://dynamodb-local.s3-website-us-west-2.amazonaws.com/dynamodb_local_latest | tar xz --directory /tmp/dynamodb
  - java -Djava.library.path=/tmp/dynamodb/DynamoDBLocal_lib -jar /tmp/dynamodb/DynamoDBLocal.jar -inMemory &
  # Install rancher metadata
  - wget https://github.com/rancher/rancher-metadata/releases/download/v0.1.0/rancher-metadata.tar.gz
  - mkdir -p ./rancher-metadata
  - tar xzf rancher-metadata.tar.gz --strip-components=1 -C ./rancher-metadata
  - sudo mv ./rancher-metadata/bin/rancher-metadata /bin/
  # Install vault
  - wget https://releases.hashicorp.com/vault/0.4.1/vault_0.4.1_linux_amd64.zip
  - unzip vault_0.4.1_linux_amd64.zip
  - sudo mv vault /bin/
  - vault server -dev &
install:
  - sudo pip install awscli
  - go get github.com/constabulary/gb/...
  - go get golang.org/x/tools/cmd/cover
  - gb build all
  - sudo ./install
script:
  - ./test
  - bash integration/consul/test.sh
  - bash integration/etcd/test.sh
  - bash integration/redis/test.sh
  - bash integration/rancher/test.sh
  - bash integration/vault/test.sh
